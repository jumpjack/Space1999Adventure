<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title></title>
  </head>
  <body>
  space1999.txt:<br>
<textarea id = "map" name="map" cols = 60 rows = 5>
WMD 1.0
ROOM 0,7,6
0,1,0,WALL|INVERT
0,2,0,WALL|INVERT
0,2,2,WINDOW|INVERT
0,3,0,RED|INVERT
0,4,0,WALL|INVERT
0,4,2,WINDOW|INVERT
0,5,0,RED|INVERT
0,6,0,WALL|INVERT
0,6,2,WINDOW|INVERT
0,7,0,WALL|INVERT
0,8,0,WALL|INVERT
1,0,0,WALL
1,1,0,PLANT|INVERT
1,7,0,SOFA_SW|INVERT
1,8,0,SOFA_SW|INVERT
1,9,0,INSET_CORNER
2,0,0,WALL
2,0,2,WINDOW
2,4,0,INFO
2,8,0,SOFA_SW|INVERT
2,9,0,INSET_WALL
3,0,0,WALL
3,0,2,WINDOW
3,1,0,SOFA_SW
3,9,0,INSETEDGE
4,0,0,WALL
4,0,2,WINDOW
4,1,0,SOFA_SW
4,3,0,SOFA_SW
4,4,0,SOFA_SW
4,4,1,SOFA_SW
4,5,0,SOFA_SW
4,8,0,COR_DOOR|SPECIAL
4,8,3,DOORJAMB
5,0,0,WALL
5,0,2,WINDOW
5,1,0,SOFA_SW
5,3,0,SOFA_SW
5,4,0,SOFA_SW
5,4,1,SOFA_SW
5,5,0,SOFA_SW
5,9,0,INSET_CORNER
6,0,0,WALL
6,0,2,WINDOW
6,3,0,SOFA_SW
6,4,0,SOFA_SW
6,4,1,SOFA_SW
6,5,0,SOFA_SW
6,8,0,SOFA_SW|INVERT
6,9,0,INSET_WALL
7,0,0,WALL
7,8,0,SOFA_SW
7,9,0,INSET_WALL
8,0,0,WALL
8,2,0,COR_DOOR|INVERT|SPECIAL
8,2,3,DOORJAMB|INVERT
8,7,0,COR_DOOR|INVERT|SPECIAL
8,7,3,DOORJAMB|INVERT
8,9,0,INSET_WALL
9,1,0,INSETEDGE|INVERT
9,3,0,INSET_CORNER|INVERT
9,4,0,INSET_WALL|INVERT
9,5,0,INSET_WALL|INVERT
9,6,0,INSETEDGE|INVERT
9,8,0,INSET_CORNER|INVERT

</textarea><br>
<br>
Tileset.txt<br>
<textarea id="tilesetlist" name="tilesetlist" cols = 60 rows = 5>
\space1999tiles
WALL wall2panel.bmp blank.bmp
RED flatredlight.bmp blank.bmp
CTRL1 flatcontrol1.bmp    blank.bmp
CTRL2 flatcontrol2.bmp    blank.bmp
GRILL    wallgrill.bmp blank.bmp
DOORJAMB wallhorizpanels0.bmp doorjamb-mask.bmp
GLASS_TILE glass.bmp SolidMask.bmp
SHELF wallshelf.bmp blank.bmp
SHOWER_PARTITION wallslope.bmp wallslope-mask.bmp
VDU wallvdu.bmp blank.bmp
COMPUTERA compA.bmp panelmask.bmp
COMPUTERB compB.bmp panelmask.bmp
RADSUIT_LOCKER radsuitlocker.bmp filingcabinet-mask.bmp
GLOBE globe.bmp globe-mask.bmp
ROOT root.bmp root-mask.bmp
STAIRN stairN.bmp stairN-s.bmp
STAIRS stairS.bmp stairS-s.bmp
TRESSLE_SHELVES tressleshelves.BMP tressleshelves-MASK.BMP
MONITOR_FRONT monitor-front.bmp monitor-mask.bmp
SOLIDBRICK Solid.bmp SolidMask.bmp
WALLCURVE1 wallcurve1.bmp wallcurve1-mask.bmp
WALLCURVE2 wallcurve2.bmp wallcurve2-mask.bmp
INSET_WALL insetwall.bmp insetwall-mask.bmp
INSET_CORNER insetwallcorner.bmp insetwallc-mask.bmp
INSETEDGE insetedge.bmp insetedge-mask.bmp
LIFT corpanel0.bmp cordoor0-mask.bmp
LIFT1 corpanel1.bmp cordoor0-mask.bmp
BATHSW bathsw.bmp block-s.bmp
SURGERY_DOOR surgerydoor0.bmp surgerydoor0-mask.bmp
SURGERY_DOOR1 surgerydoor1.bmp surgerydoor1-mask.bmp
FOLDED_TOWEL foldedtowel.bmp block-s.bmp
CHEM_DRUM drum.bmp drum-mask.bmp
BIG_SCN_L bigscreenleft.bmp blank.bmp
BIG_SCN_R bigscreenright.bmp blank.bmp
STORECUPBOARD storecupboard.bmp blank.bmp
TERMINAL terminal.bmp terminal-mask.bmp
COR_DOOR cordoor0.bmp cordoor0-mask.bmp
COR_DOOR1 cordoor1.bmp cordoor1-mask.bmp
DOUBLE_SHOWER dshower.bmp dshower-mask.bmp
INSET_WCV1 insetwc1.bmp insetwc1-mask.bmp
INSET_WCV2 insetwc2.bmp insetwc2-mask.bmp
INSIDEWALL insidewall.bmp insidewall-mask.bmp
CENTRECOLUMN centrecolumn.bmp centrecolumn-mask.bmp
INFO info.bmp info-mask.bmp
PIPESH wallpipes.bmp blank.bmp
PIPESV wallpipesvert.bmp blank.bmp
CHAIR_SE plasticchair.bmp plasticchair-mask.bmp
CHAIR_NE plasticchairne.bmp plasticchairne-mask.bmp
SIDE_CABINET sidecabinet.bmp sidecabinet-mask.bmp
RESEARCH research.bmp research-mask.bmp
SOFA_SW sofasw.bmp sofasw-mask.bmp
FILING_CABINET filingcabinet.bmp filingcabinet-mask.bmp
PLANT plant.bmp plant-mask.bmp
CONTROL_UNIT controlunit.bmp controlunit-mask.bmp
DESK_LEFT deskleft.bmp deskleft-mask.bmp
DESK_RIGHT deskright.bmp deskright-mask.bmp
WINDOW w.bmp w-mask.bmp
BENES benes.bmp benes-mask.bmp
WALL_CHIP wallchip.bmp blank.bmp
PASSCODE passcode1.bmp pyramid-mask.bmp
LAMP lamp.bmp lamp-sh.bmp
LAMPBACK lampb.bmp lampb-sh.bmp
</textarea><br>

<button onclick="process()">Convert data</button><br>
<br>
<button onclick="printRoomFile()">Show data for room n.</button><input type="text" id ="userRoomNum" name="userRoomNum" value = 0><br>
<button onclick="printWorldFile()">Show data for world</button><br>

<button onclick="printAGSroom(document.getElementById('roomNum').value,document.getElementById('layerNum').value)">Show data for room xxx, layer xxx</button>
Room: <input type=text id="roomNum" name="roomNum" value = 0> Layer: <input type=text id="layerNum" name="layerNum" value = 0> (-1 for all layers)<br>

<br>
<br>
<textarea id = "result" name="result" cols = 130 rows =30>
</textarea><br>
<br>
<textarea id = "resultRoom" name="resultRoom" cols = 130 rows =10>
</textarea><br>

<script>
// debug: to implement loading of files rather than storing inside script

COLLISION_TILE_WIDTH = 12;
COLLISION_TILE_HEIGHT = 12;
ROOM_WIDTH = 10;
ROOM_HEIGHT = 10;
MAP_WIDTH_ROOMS = 16;//6; //debug
MAP_HEIGHT_ROOMS = 16;//6; //debug
MAP_WIDTH = ROOM_WIDTH * MAP_WIDTH_ROOMS;
MAP_HEIGHT = ROOM_HEIGHT * MAP_HEIGHT_ROOMS
usedTilesLabels = [];
usedTilesCount = 0;
tileErrors = [];

// TILESET_FILENAME = "tutte.tsj"; // debug - external file, removed

TILESET_IMAGE = "img/single.png"; // embedded
TILESET_NAME = "single";
TILESET_IMAGE_WIDTH = 384;
TILESET_IMAGE_HEIGHT = 160;
TILE_WIDTH = 24;
TILE_WIDTH_MAP = 24;
TILE_HEIGHT = 40;
TILE_HEIGHT_MAP = 12
TILE_COUNT = 64;

////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Process tileset.txt file: create a named array tilesFilenames[] indexed by tile labels 
////////////////////////////////////////////////////////////////////////////////////////////////////////
/// File format:
/// WALL wall2panel.bmp blank.bmp
/// Tile Label, main image, mask image
////////////////////////////////////////////////////////////////////////////////////////////////////////
tilesFilenames = [];
tileset = document.getElementById("tilesetlist").value.split("\t").join(" "); // Get contents of tileset.txt file, removing buggish tabs.
tileset = tileset.split("    ").join(" "); // Get contents of tileset.txt file, removing buggish tabs.
tileset = tileset.split("   ").join(" "); // Get contents of tileset.txt file, removing buggish tabs.
tileset = tileset.split("  ").join(" "); // Get contents of tileset.txt file, removing buggish tabs.
document.getElementById("tilesetlist").value = tileset;
tilesetArr = tileset.split("\n");

for (var tileIndex = 1; tileIndex < tilesetArr.length; tileIndex++) { //skip header line
    tilerow = tilesetArr[tileIndex];
    if (tilerow != "") {
        tilerowArr = tilerow.split(" ");
        tileLabel = tilerowArr[0];
        tileFilename = tilerowArr[1].toUpperCase().replace(".BMP",""); // toUpperCase to overrride TRES_SHELVES tile bug
        tilesFilenames[tileLabel] = tileFilename;
        usedTilesLabels[tileLabel] = {used: false, name : tileLabel};
    }
};

console.log("Tiles in tileset:" , tilesetArr.length);

// tileset JSON data taken from Tiled-generated file (mapeditor.org):
// debug: implement loading from local file
tileSetOfficial =  [
        {
         "id":0,
         "image":"img\/bathsw.png",
         "imageheight":20,
         "imagewidth":24
        },
        {
         "id":1,
         "image":"img\/benes.png",
         "imageheight":20,
         "imagewidth":24
        },
        {
         "id":2,
         "image":"img\/bigscreenleft.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":3,
         "image":"img\/bigscreenright.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":4,
         "image":"img\/centrecolumn.png",
         "imageheight":14,
         "imagewidth":24
        },
        {
         "id":5,
         "image":"img\/compA.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":6,
         "image":"img\/compB.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":7,
         "image":"img\/controlunit.png",
         "imageheight":37,
         "imagewidth":24
        },
        {
         "id":8,
         "image":"img\/cordoor.png",
         "imageheight":32,
         "imagewidth":24
        },
        {
         "id":9,
         "image":"img\/cordoor0.png",
         "imageheight":32,
         "imagewidth":24
        },
        {
         "id":10,
         "image":"img\/cordoor1.png",
         "imageheight":32,
         "imagewidth":24
        },
        {
         "id":11,
         "image":"img\/corpanel0.png",
         "imageheight":32,
         "imagewidth":24
        },
        {
         "id":12,
         "image":"img\/corpanel1.png",
         "imageheight":32,
         "imagewidth":24
        },
        {
         "id":13,
         "image":"img\/deskleft.png",
         "imageheight":24,
         "imagewidth":24
        },
        {
         "id":14,
         "image":"img\/deskright.png",
         "imageheight":24,
         "imagewidth":24
        },
        {
         "id":15,
         "image":"img\/drum.png",
         "imageheight":38,
         "imagewidth":24
        },
        {
         "id":16,
         "image":"img\/dshower.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":17,
         "image":"img\/filingcabinet.png",
         "imageheight":38,
         "imagewidth":24
        },
        {
         "id":18,
         "image":"img\/flatcontrol1.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":19,
         "image":"img\/flatcontrol2.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":20,
         "image":"img\/flatredlight.png",
         "imageheight":40,
         "imagewidth":24
        },
        {
         "id":21,
         "image":"img\/foldedtowel.png",
         "imageheight":20,
         "imagewidth":24
        },
        {
         "id":22,
         "image":"img\/glass.png",
         "imageheight":20,
         "imagewidth":24
        },
        {
         "id":23,
         "image":"img\/globe.png",
         "imageheight":34,
         "imagewidth":24
        },
        {
         "id":24,
         "image":"img\/info.png",
         "imageheight":38,
         "imagewidth":24
        },
        {
         "id":25,
         "image":"img\/insetedge.png",
         "imageheight":39,
         "imagewidth":24
        },
        {
         "id":26,
         "image":"img\/insetwall.png",
         "imageheight":16,
         "imagewidth":24
        },
        {
         "id":27,
         "image":"img\/insetwallcorner.png",
         "imageheight":45,
         "imagewidth":24
        },
        {
         "id":28,
         "image":"img\/insetwc1.png",
         "imageheight":13,
         "imagewidth":24
        },
        {
         "id":29,
         "image":"img\/insetwc2.png",
         "imageheight":17,
         "imagewidth":24
        },
        {
         "id":30,
         "image":"img\/insidewall.png",
         "imageheight":12,
         "imagewidth":24
        },
        {
		 "id":31,
		 "image":"img\/lamp.png",
		 "imageheight":20,
		 "imagewidth":24
		},
		{
		 "id":32,
		 "image":"img\/lampb.png",
		 "imageheight":20,
		 "imagewidth":24
		},
		{
		 "id":33,
		 "image":"img\/monitor-front.png",
		 "imageheight":19,
		 "imagewidth":24
		},
		{
		 "id":34,
		 "image":"img\/passcode1.png",
		 "imageheight":20,
		 "imagewidth":24
		},
		{
		 "id":35,
		 "image":"img\/plant.png",
		 "imageheight":28,
		 "imagewidth":24
		},
		{
		 "id":36,
		 "image":"img\/plasticchair.png",
		 "imageheight":30,
		 "imagewidth":24
		},
		{
		 "id":37,
		 "image":"img\/plasticchairne.png",
		 "imageheight":24,
		 "imagewidth":24
		},
		{
		 "id":38,
		 "image":"img\/radsuitlocker.png",
		 "imageheight":38,
		 "imagewidth":24
		},
		{
		 "id":39,
		 "image":"img\/research.png",
		 "imageheight":37,
		 "imagewidth":24
		},
		{
		 "id":40,
		 "image":"img\/root.png",
		 "imageheight":28,
		 "imagewidth":24
		},
		{
		 "id":41,
		 "image":"img\/sidecabinet.png",
		 "imageheight":23,
		 "imagewidth":24
		},
		{
		 "id":42,
		 "image":"img\/sofasw.png",
		 "imageheight":18,
		 "imagewidth":24
		},
		{
		 "id":43,
		 "image":"img\/Solid.png",
		 "imageheight":20,
		 "imagewidth":24
		},
		{
		 "id":44,
		 "image":"img\/stairN.png",
		 "imageheight":20,
		 "imagewidth":24
		},
		{
		 "id":45,
		 "image":"img\/stairS.png",
		 "imageheight":17,
		 "imagewidth":24
		},
		{
		 "id":46,
		 "image":"img\/storecupboard.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":47,
		 "image":"img\/surgerydoor0.png",
		 "imageheight":38,
		 "imagewidth":24
		},
		{
		 "id":48,
		 "image":"img\/surgerydoor1.png",
		 "imageheight":38,
		 "imagewidth":24
		},
		{
		 "id":49,
		 "image":"img\/terminal.png",
		 "imageheight":23,
		 "imagewidth":24
		},
		{
		 "id":50,
		 "image":"img\/tressleshelves.png",
		 "imageheight":37,
		 "imagewidth":24
		},
		{
		 "id":51,
		 "image":"img\/w.png",
		 "imageheight":17,
		 "imagewidth":24
		},
		{
		 "id":52,
		 "image":"img\/wall2panel.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":53,
		 "image":"img\/wallchip.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":54,
		 "image":"img\/wallcurve1.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":55,
		 "image":"img\/wallcurve2.png",
		 "imageheight":46,
		 "imagewidth":24
		},
		{
		 "id":56,
		 "image":"img\/wallgrill.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":57,
		 "image":"img\/wallhorizpanels0.png",
		 "imageheight":16,
		 "imagewidth":24
		},
		{
		 "id":58,
		 "image":"img\/wallpipes.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":59,
		 "image":"img\/wallpipesvert.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":60,
		 "image":"img\/wallshelf.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":61,
		 "image":"img\/wallslope.png",
		 "imageheight":40,
		 "imagewidth":24
		},
		{
		 "id":62,
		 "image":"img\/wallvdu.png",
		 "imageheight":40,
		 "imagewidth":24
		}];

///////// Create a named array offTiles[] indexed by filename without extension and containing tiles ids/numbers //////////
offTiles = [];
tileSetOfficial.forEach((offTile) => {
	originalFileName = offTile.image;
	bareFileName = originalFileName.replace("img\/","").replace(".png",""); // remove path and extension
	upperFileName = bareFileName.toUpperCase()
	offTiles[upperFileName] = offTile.id;
});


LAYER_TEMPLATE = '        {\n\
        "draworder":"topdown",\n\
         "data":#DATA#,\n\
         "height":#HEIGHT2#,\n\
         "id":#LAYERNUMBER#,\n\
         "name":"level #LAYERNUMBER2#",\n\
         "opacity":1,\n\
         "offsety": #OFFSETY#,\n\
         "type":"tilelayer",\n\
         "visible":true,\n\
         "width":#WIDTH2#,\n\
         "x":0,\n\
         "y":0\n\
        }';

LAYER_OFFSETY = [0, -7, -14, -21, -28 /*debug*/];

COLLISION_TILE_TEMPLATE = '                {\n\
                 "class":"",\n\
                 "height":#COLLH#,\n\
                 "id":#TILE_ID#,\n\
                 "name":"",\n\
                 "rotation":0,\n\
                 "visible":true,\n\
                 "width":#COLLW#,\n\
                 "x":#COLLX#,\n\
                 "y":#COLLY#\n\
                }';

COLLISION_LAYER_TEMPLATE = '        {\n\
         "draworder":"topdown",\n\
         "id":#COLLISION_LAYER_ID#,\n\
         "name":"collisions",\n\
         "objects":[\n\
                #COLLISION_TILES#\n\
                ],\n\
         "opacity":1,\n\
         "type":"objectgroup",\n\
         "visible":true,\n\
         "x":0,\n\
         "y":0\n\
        }';

PLAYER_TEMPLATE = '        {\n\
         "draworder":"topdown",\n\
         "id":#PLAYER_LAYER_ID#,\n\
         "name":"Player",\n\
         "objects":[\n\
                {\n\
                 "height":12,\n\
                 "id":1,\n\
                 "name":"mainPlayer",\n\
                 "rotation":0,\n\
                 "type":"actor1m",\n\
                 "visible":true,\n\
                 "width":12,\n\
                 "x":24,\n\
                 "y":24\n\
                }],\n\
         "opacity":1,\n\
         "type":"objectgroup",\n\
         "visible":true,\n\
         "x":0,\n\
         "y":0\n\
        }';

// Contents of final map file:
TMJtemplate = '{ "compressionlevel":-1,\n\
 "height":#HEIGHT#,\n\
 "infinite":false,\n\
 "layers":[\n\
     #LAYERS#\n\
 ],\n\
 "nextlayerid":2,\n\
 "nextobjectid":1,\n\
 "orientation":"isometric",\n\
 "renderorder":"right-down",\n\
 "tiledversion":"1.9.2",\n\
 "tileheight":#TILE_HEIGHT_MAP#,\n\
 "tilesets":[\n\
        {\n\
         "columns":10,\n\
         "firstgid":1,\n\
         "image":"#TILESET_IMAGE#",\n\
         "imageheight":#TILESET_IMAGE_HEIGHT#,\n\
         "imagewidth":#TILESET_IMAGE_WIDTH#,\n\
         "margin":0,\n\
         "name":"#TILESET_NAME#",\n\
         "spacing":0,\n\
         "tilecount":#TILE_COUNT#,\n\
         "tileheight":#TILE_HEIGHT#,\n\
         "tilewidth":#TILE_WIDTH#\n\
        }],\n\
 "tilewidth":#TILE_WIDTH_MAP#,\n\
 "type":"map",\n\
 "version":"1.9",\n\
 "width":#WIDTH#\n\
}';

TMJ = TMJtemplate.replace("#HEIGHT#",MAP_HEIGHT);
TMJ = TMJ.replace("#WIDTH#",MAP_WIDTH);
TMJ = TMJ.replace("#TILESET_IMAGE#",TILESET_IMAGE);
TMJ = TMJ.replace("#TILESET_IMAGE_WIDTH#",TILESET_IMAGE_WIDTH);
TMJ = TMJ.replace("#TILESET_IMAGE_HEIGHT#",TILESET_IMAGE_HEIGHT);

TMJ = TMJ.replace("#TILESET_NAME#",TILESET_NAME);
TMJ = TMJ.replace("#TILE_WIDTH#",TILE_WIDTH);
TMJ = TMJ.replace("#TILE_WIDTH_MAP#",TILE_WIDTH_MAP);
TMJ = TMJ.replace("#TILE_HEIGHT#",TILE_HEIGHT);
TMJ = TMJ.replace("#TILE_HEIGHT_MAP#",TILE_HEIGHT_MAP);
TMJ = TMJ.replace("#TILE_COUNT#",TILE_COUNT);



/*
TILESET_NAME = "single";
TILE_WIDTH = 24;
TILE_WIDTH_MAP = 24;
TILE_HEIGHT = 40;
TILE_HEIGHT_MAP = 12
TILE_COUNT = 64;

*/

LayerData = LAYER_TEMPLATE.replace("#HEIGHT2#",MAP_HEIGHT);
LayerData = LayerData.replace("#WIDTH2#",MAP_WIDTH);

collisionData = COLLISION_TILE_TEMPLATE.replace("#COLLH#",COLLISION_TILE_HEIGHT);
collisionData = collisionData.replace("#COLLW#",COLLISION_TILE_WIDTH);

console.log("READY.");

function process() {
    myMap = document.getElementById("map").value;
    roomsRaw = [];
    rooms = [];
    roomArrRaw = myMap.split("ROOM");
    roomArrRaw.forEach( (roomRaw) => {
        roomsRaw.push(roomRaw.split("\n"));
    });

    roomMap = [
    ];

    roomMapStr = [
    ];

    roomCollisionsMap = [
    ];

    for (var Windex = 0; Windex < MAP_WIDTH; Windex++) {
        mapRowArr = [];
        mapRowArrStr = [];
        mapRowCollArr = [];
        for (var Hindex = 0; Hindex < MAP_HEIGHT; Hindex++) {
            mapRowArr.push(0);
            mapRowArrStr.push("");
        }
        roomMap.push(mapRowArr.valueOf());
        roomMapStr.push(mapRowArrStr.valueOf());
				roomCollisionsMap.push(mapRowCollArr.valueOf());
    }


    roomMapLayers = [
    ];

    roomMapStrLayers = [
    ]
/*
    singleMapStringifiedLayers =  [];
    singleMapStringifiedLayers_16 =  [];
*/
    singleCollisionsMap =     [
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0],
                                [0,0,0,0,0,0,0,0,0,0]
                            ];

    CONV_FACT = Math.pow(2,32)/2 + 1; // 10 inv = 2147483659 = CONV_FACT+ID+1
    CONV_FACT_16 = Math.pow(2,16)/2 + 1; // 10 inv = 32779 = CONV_FACT_16 + ID + 1

    finalRoom = {
        data: {
            x : -1,
            y : -1
        },
        location: {
            x : -1,
            y : -1
        }/*,
        map : {
            layersRaw: [[[[]]]]
        }*/
    }

    ////// Pre-determine total number of layers
    for (roomRawIndex = 1; roomRawIndex < roomsRaw.length; roomRawIndex++) {
      roomProcessed = roomsRaw[roomRawIndex];
      layersCount = 0;
      for (var rowIndex = 1; rowIndex < roomProcessed.length; rowIndex++) {
        rowArr = roomProcessed[rowIndex].split(",");
        if (rowArr.length > 3) {
          layer = rowArr[2]*1
          if (layer > layersCount-1) {
            layersCount=layer  ;
          }
        }
      }
    }


    ///// Setup the variables to hold the maps:
    roomMapLayers = Array(layersCount+1).fill().map(() => Array(MAP_WIDTH).fill().map(()=>Array(MAP_HEIGHT).fill(0)));
    roomMapStrLayers = Array(layersCount+1).fill().map(() => Array(MAP_WIDTH).fill().map(()=>Array(MAP_HEIGHT).fill(0)));

    roomMapLayers_16 = Array(layersCount+1).fill().map(() => Array(MAP_WIDTH).fill().map(()=>Array(MAP_HEIGHT).fill(0)));
    roomMapStrLayers_16 = Array(layersCount+1).fill().map(() => Array(MAP_WIDTH).fill().map(()=>Array(MAP_HEIGHT).fill(0)));

    ///////////


    for (roomRawIndex = 1; roomRawIndex < roomsRaw.length; roomRawIndex++) {
    singleMapLayers = Array(layersCount+1).fill().map(() => Array(ROOM_WIDTH).fill().map(()=>Array(ROOM_HEIGHT).fill(0)));
    singleMapStrLayers = Array(layersCount+1).fill().map(() => Array(ROOM_WIDTH).fill().map(()=>Array(ROOM_HEIGHT).fill(0)));
    singleMapLayers_16 = Array(layersCount+1).fill().map(() => Array(ROOM_WIDTH).fill().map(()=>Array(ROOM_HEIGHT).fill(0)));
    singleMapStrLayers_16 = Array(layersCount+1).fill().map(() => Array(ROOM_WIDTH).fill().map(()=>Array(ROOM_HEIGHT).fill(0)));
        roomProcessed = roomsRaw[roomRawIndex];
        roomData = roomProcessed[0].split(","); // debug: what are these?
        roomNumber = roomData[0]*1
        finalRoom.number = roomNumber;
        finalRoom.data.x = roomData[1]*1;
        finalRoom.data.y = roomData[2]*1;
        roomX = roomNumber%16; roomY = Math.floor(roomNumber/16);
        finalRoom.location.x = roomX;
        finalRoom.location.y = roomY;
console.log("Processing room ", roomRawIndex, ", id:", roomNumber, ", location:", roomX, roomY);

        // Process data for the room, line by line
        for (var rowIndex = 1; rowIndex < roomProcessed.length; rowIndex++) {
            rowArr = roomProcessed[rowIndex].split(",");
            if (rowArr.length > 3) {
                // row format is: X, Y, LAYER, TILENAME|TILEOPTIONS
                 x = rowArr[0]*1 + roomX * ROOM_WIDTH;
                 y = rowArr[1]*1 + roomY * ROOM_HEIGHT;
                 singleX = rowArr[0]*1;
                 singleY = rowArr[1]*1;
                 layer = rowArr[2]*1
                 tileRaw = rowArr[3].split("|");
//console.log("Processing ", x,y, layer, tileRaw);
                tileName = tileRaw[0];
                if (!usedTilesLabels[tileName]) {
                    usedTilesLabels[tileName] = {used: true, name: tileName};
                }
                if (!usedTilesLabels[tileName].used) {
                    usedTilesLabels[tileName] = {
                        used : true,
                        name : tileName
                    }
                    usedTilesCount++;
                };
                tileInvert=tileRaw[1]; // debug - can be nothing, INVERT or "SPECIAL", which means the tile can be "collided into":
                // Original comment from developer: "Remember that WHITE will report collisions with every object with the SPECIAL flag set (except if ID is 0)."
               // if (layer === 0 ) { // debug: only one layer supported as of now

                    idRaw = offTiles[tilesFilenames[tileName]]; // Determine a preliminary tile id
                    if ( (!isNaN(idRaw)) && (idRaw != undefined)) {
                        id = idRaw + 1; // Standard tile: add 1 to tile id
                        if (tileInvert == "INVERT") {
                            id = idRaw + CONV_FACT; // Horizontally flipped tile ("INVERTED"): add conversion factor
                        }
                    } else {
                        if (tileName == "TRANSP_WALL") { // Special tile without imagefile
                            id = 63; // empty tile - offTiles[tilesFilenames["WALL"]]; // Debug: TRANSP_WALL to be properly managed
                            if (tileInvert) {
                                id = id + CONV_FACT;
                            } else {
                                id = id + 1;
                            }
                        } else {
                            tileErrors.push({_room: roomNumber, x:x, y:y, layer: layer, tileRaw: rowArr[3], label: tilesFilenames[tileName], official: idRaw});
                            id = -1;
//console.log("Error in room ", roomNumber, ", tile '" , rowArr , "' on ", x,y, singleX, singleY, idRaw, id,tileName, tilesFilenames[tileName], rowArr);
                        }
                    }

//console.log("     Storing " + id + " into roomMapLayers["+ layer + "," + y + "," + x + "], row=",roomProcessed[rowIndex] + ", data=", rowArr[1]*1 , roomY * ROOM_HEIGHT, rowArr[1]*1 + roomY * ROOM_HEIGHT,roomNumber);

                    if (id > CONV_FACT) {
                      id_16 = id - CONV_FACT + CONV_FACT_16;
                    } else {
                      id_16 = id;
                    }

                    roomMapLayers[layer][y][x] = id; // Store map as numbers, for Tiled
                    roomMapLayers_16[layer][y][x] = id_16; // Store map as numbers, in Tiled format but in 16-bit for Advewnture Game Studio
                    roomMapStrLayers[layer][y][x] = tileName; // Store map as strings, for developer...

                    if (layer == 0) {
                        if (rowArr[3].indexOf("SPECIAL") >= 0 ) {
                            roomCollisionsMap[y][x] = 2;
                           singleCollisionsMap[singleY][singleX] = 2;
                        } else {
                            roomCollisionsMap[y][x] = 1;
                            singleCollisionsMap[singleY][singleX] = 1;
                        }
                    }

                    singleMapLayers[layer][singleY][singleX]=id;
                    singleMapLayers_16[layer][singleY][singleX]=id_16;
                    singleMapStrLayers[layer][singleY][singleX]=tileName;

                    id = -999;
                    tileName = "empty";
               // } else {
                // Manage other layers
               // }
            } else {
            // invalid row, skip
            }
        }
         finalRoom.mapArrNumbers = roomMapLayers;
         finalRoom.mapArrNumbers_16 = roomMapLayers_16;
         finalRoom.mapArrStrings = roomMapStrLayers;
         finalRoom.mapArrStrings_16 = roomMapStrLayers_16;

				LAYERS_COUNT = layer - 1;

        ////////////// Convert world map data into printable string for Tiled .tmj file:
        layerNumber = 0;
        mapStringified = [];
        finalRoom.map = [];
        roomMapLayers.forEach( (layer) => {
						cellNum = 0;
            mapStringified[layerNumber] = "\n";
            layer.forEach( (mapRow) => {
                mapRow.forEach((cell) => {
                    if (cellNum < MAP_WIDTH * MAP_HEIGHT) {
                      finalChar = ",";
                    } else {
                      finalChar = "";
                    }
                    mapStringified[layerNumber] += cell + finalChar;
                    cellNum++;
                });
                mapStringified[layerNumber] += "\n";
            });
            mapStringified[layerNumber] = mapStringified[layerNumber].substr(0, mapStringified[layerNumber].length-2);
            //mapStringified[layerNumber] += "]"
//console.log(mapStringified[layerNumber]);
            finalRoom.map.push(mapStringified[layerNumber]); // Store map in room as string.
            layerNumber++;
        });

    singleMapStringifiedLayers =  [];
    singleMapStringifiedLayers_16 =  [];

//console.log("Room " , roomRawIndex, ", map:", singleMapStringifiedLayers);
        ///////////// Convert single room map data into printable string for Tiled .tmj file:
        layerNumber = 0;
		var cell;
		var cell_16;
		var finalChar;
        singleMapLayers.forEach((layer) => {
            var cellNum = 0;
            var singleMapStringified = "";
            var singleMapStringified_16 = 'mapStrTiled = mapStrTiled.Append("';
            layer.forEach( (mapRow) => {
                mapRow.forEach((cell) => {
//console.log(cell);
                    if (cellNum < ROOM_WIDTH * ROOM_HEIGHT - 1) {
                      finalChar = ",";
                    } else {
                      finalChar = "";
                    }
                    if (cell > CONV_FACT) {
                      cell_16 = cell - CONV_FACT + CONV_FACT_16;
                    } else {
                      cell_16 = cell;
                    }
                    singleMapStringified += cell + finalChar;
                    singleMapStringified_16 += cell_16 + finalChar;
                    cellNum++;
                });
                singleMapStringified += "\n                 ";
                singleMapStringified_16 += '");\nmapStrTiled = mapStrTiled.Append("';
            });
//console.log("");
            singleMapStringified = singleMapStringified.substr(0, singleMapStringified.length-2);
            singleMapStringified_16 = singleMapStringified_16.substr(0, singleMapStringified_16.length-34);
            //singleMapStringified += "]"
            singleMapStringifiedLayers.push(singleMapStringified);
            singleMapStringifiedLayers_16.push(singleMapStringified_16);
        });
//console.log(singleMapStringifiedLayers);

        rooms.push({
            location : {
                x : roomX,
                y : roomY
            },
            number : roomNumber,
            map : singleMapLayers,
            map_16 : singleMapLayers_16,
            mapStr : singleMapStrLayers,
            mapStringified : singleMapStringifiedLayers,
            mapStringified_16 : singleMapStringifiedLayers_16,
            collisionMap : singleCollisionsMap,
        });  // Store room in array
    }; // rooms cycle

    if (tileErrors.length>0) {
        alert("Errors, see console");
        console.log(tileErrors);
    }
//    console.log("Used tiles:", Object.keys(usedTilesLabels).length, usedTilesLabels);
    for (var index in usedTilesLabels) {
        if (!usedTilesLabels[index].used) {
//console.log("Tile '" + usedTilesLabels[index].name  + "' is never used.");
        }
    }
    console.log("Done.");
	alert("Done.");
}

function printAGSmap() {
// mapStrTiled = mapStrTiled.Append("0, 53, 53, 53, 53, 53, 53, 53, 53, 0,");
    currRoom = rooms[document.getElementById("userRoomNum").value*1];
    allLayers = "";
console.log("AGS Room ", currRoom);
    for (layerNumber = 0; layerNumber < currRoom.map.length; layerNumber++) {
        currLayer = LayerData.replace("#DATA#","[" + currRoom.mapStringified_16[layerNumber] + "]");
        currLayer = currLayer.replace("#LAYERNUMBER#",layerNumber);
        currLayer = currLayer.replace("#LAYERNUMBER2#",layerNumber);
        currLayer = currLayer.replace("#OFFSETY#",LAYER_OFFSETY[layerNumber]);
        if (layerNumber < currRoom.map.length - 1) {
            allLayers += currLayer + ",\n";
        } else {
            allLayers += currLayer + "\n";
        }
    };
}


function printRoomFile() {
    currRoom = rooms[document.getElementById("userRoomNum").value*1];
    allLayers = "";
console.log("Room ", currRoom);
    for (layerNumber = 0; layerNumber < currRoom.map.length; layerNumber++) {
        currLayer = LayerData.replace("#DATA#","[" + currRoom.mapStringified[layerNumber] + "]");
        currLayer = currLayer.replace("#LAYERNUMBER#",layerNumber);
        currLayer = currLayer.replace("#LAYERNUMBER2#",layerNumber);
        currLayer = currLayer.replace("#OFFSETY#",LAYER_OFFSETY[layerNumber]);
        if (layerNumber < currRoom.map.length - 1) {
            allLayers += currLayer + ",\n";
        } else {
            allLayers += currLayer + "\n";
        }
    };

    //// Add collisions layer:
    collisionGroup = "";
    collMap = currRoom.collisionMap;
    collTiles = "";
    tileId = 0;
    for (var x = 0; x <collMap.length; x++) {
        for (var y = 0; y <collMap[x].length; y++) {
            if ( collMap[y][x] == 1) {
                collX = COLLISION_TILE_WIDTH * (x-1);
                collY = COLLISION_TILE_HEIGHT * (y-1);
                collisionTile = collisionData.replace("#COLLX#",collX);
                collisionTile = collisionTile.replace("#COLLY#",collY);
                collisionTile = collisionTile.replace("#TILE_ID#",tileId);
                collTiles += collisionTile + ",\n";
                tileId++;
            }
        }
    }
    collTiles = collTiles.substr(0,collTiles.length-2); // remove final comma
    collLayer = COLLISION_LAYER_TEMPLATE.replace("#COLLISION_TILES#",collTiles);
    collLayer = collLayer.replace("#COLLISION_LAYER_ID#",layerNumber);
    allLayers += ",\n" + collLayer;

  layerNumber++

    /// Add player layer
    playerLayer = PLAYER_TEMPLATE.replace("#PLAYER_LAYER_ID#",layerNumber);
    allLayers += ",\n" + playerLayer;

    finalString = TMJ.replace("#LAYERS#",allLayers);

    document.getElementById("resultRoom").value = TMJ.replace("#LAYERS#",allLayers);
    document.getElementById("result").value = TMJ.replace("#LAYERS#",allLayers);

console.log(singleMapLayers[0][0]);
console.log(singleMapLayers[1][0]);
console.log(singleMapLayers[2][0]);
console.log(singleMapLayers[3][0]);
}


function printAGSroom(room,layer) {
	document.getElementById("result").value = "";
	if (layer >= 0) {
		document.getElementById("result").value +='String mapStrTiled' + layer + '= "";\n';
		document.getElementById("result").value += rooms[room].mapStringified_16[layer].split("mapStrTiled").join("mapStrTiled"+layer);
	} else {
		for (var l=0; l<=4; l++) {
			document.getElementById("result").value += 'String mapStrTiled' + l + '= "";\n';
			document.getElementById("result").value += rooms[room].mapStringified_16[l].split("mapStrTiled").join("mapStrTiled"+l);
		}
	}
}

function printWorldFile() {
    currRoom = finalRoom;
    allLayers = "";
console.log("Room ", currRoom);
    for (layerNumber = 0; layerNumber < currRoom.map.length; layerNumber++) {
        currLayer = LayerData.replace("#DATA#","[" + currRoom.map[layerNumber] + "]");
        currLayer = currLayer.replace("#LAYERNUMBER#",layerNumber);
        currLayer = currLayer.replace("#LAYERNUMBER2#",layerNumber);
        currLayer = currLayer.replace("#OFFSETY#",LAYER_OFFSETY[layerNumber]);
      if (layerNumber < currRoom.map.length - 1) {
                allLayers += currLayer + ",\n";
            } else {
                allLayers += currLayer + "\n";
            }
    };
console.log(roomMapLayers[0][0]);
console.log(roomMapLayers[1][0]);
console.log(roomMapLayers[2][0]);
console.log(roomMapLayers[3][0]);
/*
    //// Add collisions layer:
    collisionGroup = "";
    collMap = currRoom.collisionMap;
    collTiles = "";
    tileId = 0;
    for (var x = 0; x <collMap.length; x++) {
        for (var y = 0; y <collMap[x].length; y++) {
            if ( collMap[y][x] == 1) {
                collX = COLLISION_TILE_WIDTH * (x-1);
                collY = COLLISION_TILE_HEIGHT * (y-1);
                collisionTile = collisionData.replace("#COLLX#",collX);
                collisionTile = collisionTile.replace("#COLLY#",collY);
                collisionTile = collisionTile.replace("#TILE_ID#",tileId);
                collTiles += collisionTile + ",\n";
                tileId++;
            }
        }
    }
    collTiles = collTiles.substr(0,collTiles.length-2); // remove final comma
    collLayer = COLLISION_LAYER_TEMPLATE.replace("#COLLISION_TILES#",collTiles);
    collLayer = collLayer.replace("#COLLISION_LAYER_ID#",layerNumber);
    allLayers += ",\n" + collLayer;

*/

  layerNumber++

    /// Add player layer
    playerLayer = PLAYER_TEMPLATE.replace("#PLAYER_LAYER_ID#",layerNumber);
    allLayers += ",\n" + playerLayer;

    finalString = TMJ.replace("#LAYERS#",allLayers);



    document.getElementById("resultRoom").value = TMJ.replace("#LAYERS#",allLayers);
    document.getElementById("result").value = TMJ.replace("#LAYERS#",allLayers);
}


</script>
  </body>
</html>
